"use strict";
var xmad = function(b, c) {

    function d() {
        function K() {
            return Math.floor(65536 * (1 + Math.random())).toString(16).substring(1)
        }
        var L;
        try {
            if (L = wx.getStorageSync("xmaduuid"), L) return L
        } catch (M) {}
        L = K() + K() + K() + K() + K() + K() + K() + K();
        try {
            wx.setStorageSync("xmaduuid", L)
        } catch (M) {}
        return L
    }

    function f(K) {
        var L = K.currentTarget.dataset.id,
            M = this.data.xmad;
        M.adData[L].hasshow = !1, this.setData({
            xmad: M
        })
    }

    function g(K) {
        var L = K.currentTarget.dataset.id,
            M = p[L].curl.replace(/cst=/gi, "cst=" + Date.now());
        M = M.split("?")[1];
        var N = p[L].at;
        if (1 === N) {
            var O = j ? n.h5_path || "/pages/xmadH5" : n.h5_path || "/pages/xmadH5/xmadH5",
                P = p[L].h5link.replace("?", "|").replace("=", "$");
            P && wx.navigateTo({
                url: O + "?xmadH5url=" + P,
                success: function success() {
                    J(M, "v1/api/clk", ["log", "imp"], function() {}, "get")
                },
                fail: function fail() {
                    console.warn("小盟提示：跳转H5广告失败，请在xmadx_conf.js中正确配置h5_path字段。")
                }
            })
        }
        2 === N && (!K.currentTarget.dataset.adImgUrl && (K.currentTarget.dataset.adImgUrl = p[L].appimg), wx.previewImage({
            current: K.currentTarget.dataset.adImgUrl,
            urls: [K.currentTarget.dataset.adImgUrl],
            success: function success() {
                J(M, "v1/api/clk", ["log", "imp"], function() {}, "get")
            }
        })), 3 === N && J(M, "v1/api/clk", ["log", "imp"], function() {}, "get"), 1 !== N && 2 !== N && 3 !== N && console.error("SDK错误：跳转类型at为：" + N + "，不是约定的类型。无法进行跳转、点击上报，联系GO工程师！！！")
    }

    function h(K, L, M) {
        if (K[L]) {
            var N = K[L];
            K[L] = function(O) {
                return N.call.apply(N, [this].concat(Array.prototype.slice.call(arguments))), M.call(this, O, K)
            }
        } else K[L] = function(O) {
            M.call(this, O, L)
        }
    }


    try {
        var j = "wepy" === b
    } catch (K) {}


    try {
        var F = b.prototype.constructor.name;
        if (F) {
            var k, l;
            "App" === c ? k = b : l = b
        }
    } catch (K) {}

    var n = require("./xmadx_conf.js"),
        o = require("./xmadx_MD5.js"),
        G = 0,
        p = {};
    if (!n.app_key || 32 !== n.app_key.length) {
        console.warn("小盟提示：配置错误，请在xmadx_conf.js中正确配置您的app_key。");
        return {
            xmApp: function H(K) {
                k ? k(K) : App(K)
            },
            xmPage: function I(K) {
                l ? l(K) : Page(K)
            }
        }
    }
    var q = {
            ak: n.app_key.replace(/(^\s*)|(\s*$)/g, ""),
            v: "1.3.5",
            asid: "",
            reqid: "",
            pb: "",
            pm: "",
            sv: "",
            pv: "",
            nt: "",
            ww: 0,
            wh: 0,
            pr: 0,
            long: 0,
            lat: 0,
            wvv: "",
            wv: "",
            lang: "",
            wsr: {},
            pp: "",
            uuid: "",
            user_info: {}
        },
        r = 0,
        s = function(K) {
            function L() {
                var R = 4 === M.length;
                R && K && (r = 1, K())
            }
            var M = [];
            (function N() {
                wx.getSetting({
                    success: function success(R) {
                        R.authSetting["scope.userInfo"] ? wx.getUserInfo({
                            withCredentials: !1,
                            success: function success(S) {
                                q.user_info = S.userInfo
                            },
                            complete: function complete() {
                                M.push("ok1"), L()
                            }
                        }) : (M.push("ok1"), L())
                    },
                    fail: function fail() {
                        M.push("ok1"), L()
                    }
                })
            })(),
                function O() {
                    wx.getSystemInfo({
                        success: function success(R) {
                            q.wv = "undefined" == typeof R.SDKVersion ? "1.0.0" : R.SDKVersion, q.pb = R.brand, q.pm = R.model, q.pr = R.pixelRatio, q.ww = R.screenWidth, q.wh = R.screenHeight, q.lang = R.language, q.wvv = R.version, q.sv = R.system, q.pv = R.platform
                        },
                        complete: function complete() {
                            M.push("ok2"), L()
                        }
                    })
                }(),
                function P() {
                    wx.getSetting({
                        success: function success(R) {
                            R.authSetting["scope.userLocation"] ? wx.getLocation({
                                type: "wgs84",
                                success: function success(S) {
                                    q.long = S.latitude, q.lat = S.longitude
                                },
                                complete: function complete() {
                                    M.push("ok3"), L()
                                }
                            }) : (M.push("ok3"), L())
                        },
                        fail: function fail() {
                            M.push("ok3"), L()
                        }
                    })
                }(),
                function Q() {
                    wx.getNetworkType({
                        success: function success(R) {
                            q.nt = R.networkType
                        },
                        complete: function complete() {
                            M.push("ok4"), L()
                        }
                    })
                }()
        },
        t = function(K) {
            wx.setStorageSync("xmwsr", K);
            var M = d();
            q.uuid = M, s()
        },
        u = function() {
            var K = this.options.xmadH5url;
            K && (K = K.replace("|", "?").replace("$", "="), this.setData({
                xmadURL: K
            }))
        },
        w = function() {
            q.wsr = wx.getStorageSync("xmwsr"), q.pp = this.route;
            try {
                var K = this.data.xmad.ad
            } catch (M) {}
            if (K)
                for (var L in K) y(this, K[L])
        },
        x = function(K, L) {
            wx.createSelectorQuery().selectAll(K).boundingClientRect(function(M) {
                if (L) return L(0 < M.length)
            }).exec()
        },
        y = function(K, L) {
            return 32 == L.length ? void A(L, ["engine", "v1/api/ad"], function(M) {
                if (200 == M.data.code) {
                    var N = M.data.data;
                    p[L] = N, p[L].hasshow = !0, p[L].id = L, p[L].push = 0, 1 === N.ct && x(".xm_banner", function(P) {
                        return P ? void(E.banner_calc(function() {
                            p[L].style = E.banner_style
                        }), O()) : (p[L] = "", console.warn("小盟提示：您在js中配置的" + L + "为banner广告，而wxml中没有\"xm_banner\"代码,请检查"))
                    }), 2 === N.ct && x(".xm_insert", function(P) {
                        return P ? void(p[L].style = E.screen_style, O()) : (p[L] = "", console.warn("小盟提示：您在js中配置的" + L + " 为插屏广告，而wxml中没有'xm_insert'代码,请检查"))
                    }), 3 === N.ct && x(".xm_fixed", function(P) {
                        return P ? void(p[L].style = E.type3, O()) : (p[L] = "", console.warn("小盟提示：您在js中配置的" + L + " 为悬浮窗广告，而wxml中没有'xm_fixed'代码,请检查"))
                    });
                    var O = function() {
                        var Q = K.data.xmad;
                        Q.adData = p, j ? K.xmapply(p) : K.setData({
                            xmad: Q
                        });
                        var P = N.iurl.replace(/ist=/gi, "ist=" + Date.now());
                        P = P.split("?")[1], z(K, P, L, N.ct)
                    }
                } else;
            }) : console.warn("广告位ID应为长度为32位，请检查您在js中'xmad'的配置--" + L)
        },
        z = function(K, L, M, N) {
            function O() {
                if (1 === N) {
                    var P = wx.createIntersectionObserver(this, {
                        thresholds: [0.2],
                        selectAll: !0
                    });
                    return void P.relativeToViewport().observe(".xm_banner", function(Q) {
                        var R = K.data.xmad;
                        0.2 < Q.intersectionRatio && 0 === R.adData[M].push && (R.adData[M].push = 1, K.setData({
                            xmad: R
                        }), J(L, "v1/api/imp", ["log", "imp"], function() {}, "get"), P.disconnect())
                    })
                }
                J(L, "v1/api/imp", ["log", "imp"], function() {}, "get")
            }
            wx.createSelectorQuery().selectAll(".xm_component").boundingClientRect(function(P) {
                for (var Q = 0; Q < P.length; Q++) P[Q].dataset.id === M && O()
            }).exec()
        },
        J = function(K, L) {
            var M = M ? "get" : "post",
                N = "https://log.xmadx.net/",
                O = {};
            /imp/.test(L) ? O.iurl = K : O.curl = K;
            var P = 0,
                Q = function() {
                    wx.request({
                        url: N + L,
                        data: O,
                        method: M ? "post" : "get",
                        success: function success() {},
                        fail: function fail() {
                            2 > P && (P++, O.retryTimes = P, setTimeout(function() {
                                Q()
                            }, 1e3))
                        }
                    })
                };
            Q()
        },
        A = function(K, L, M, N) {
            0 == r ? s(function() {
                B(K, M, L, N)
            }) : B(K, M, L, N)
        },
        B = function(K, L, M, N) {
            var N = N ? "get" : "post",
                R = "https://" + M[0] + ".xmadx.net/";
            if (q.asid = K, q.uuid = d(), "log" != M[0]) {
                var O = Date.now() + q.ak + q.uuid + q.asid;
                q.reqid = o.hexMD5(O)
            }
            var P = 0,
                Q = function() {
                    wx.request({
                        url: R + M[1],
                        data: q,
                        header: {},
                        method: N,
                        success: function success(S) {
                            L(S)
                        },
                        fail: function fail() {
                            2 > P && (P++, q.retryTimes = P, setTimeout(function() {
                                Q()
                            }, 1e3))
                        }
                    })
                };
            Q()
        },
        C = function(K) {
            h(K, "onLaunch", t), C.prototype.xmad = "xmad", k ? k(K) : App(K)
        },
        E = {
            banner_style: {
                wrap: "width: 100%; height: 166rpx; overflow: hidden; position: relative;",
                icon: "width: 92rpx!important; height: 34rpx!important; line-height: 34rpx; background: rgba(0, 0, 0, .3); font-size: 20rpx; position: absolute; left: 10rpx; top: 14rpx; color: #fff; text-align: center; border-radius: 16rpx;",
                img: "width: 100%; height: 166rpx;",
                nav: "position:absolute;left:0;right:0;top:0;bottom:0;margin:0;background:none;"
            },
            banner_calc: function banner_calc(K) {
                var L = this;
                wx.getSystemInfo({
                    success: function success(M) {
                        var N = M.screenWidth,
                            O = 2 * (166 * N / 582);
                        L.banner_style.wrap = "width: 100%!important; height:" + O + "rpx; overflow: hidden; position: relative;", L.banner_style.img = "width: 100%!important; height:" + O + "rpx;", K(L.banner_style)
                    }
                })
            },
            screen_style: {
                wrap: "position: fixed; width: 100%; height: 100%; left: 0; top: 0; background: rgba(0, 0, 0, .3); z-index: 9999;",
                content: "position:relative;width: 600rpx!important; height: 500rpx; overflow: hidden; left: calc(50% - 300rpx); top: calc(50% - 250rpx)",
                img: " width: 100%; height: 500rpx!important;",
                close: "position: absolute; right: 0; top: 0; padding: 11rpx; width: 46rpx!important; height: 46rpx!important;z-index:2",
                nav: "position:absolute;left:0;right:0;top:0;bottom:0;margin:0;background:none;",
                icon: "width: 98rpx!important; height: 34rpx!important; line-height: 34rpx; background: rgba(0, 0, 0, .3); font-size: 20rpx; position: absolute; left: 10rpx; bottom: 14rpx; color: #fff; text-align: center; border-radius: 16rpx;"
            },
            type3: {
                wrap: "position: fixed; width: 120rpx!important; height: 120rpx!important; right: 60rpx; bottom: 60rpx; z-index: 9998;",
                img: " width: 100%; height: 100%;",
                nav: "position:absolute;left:0;right:0;top:0;bottom:0;margin:0;background:none;"
            }
        };
    return {
        xmApp: C,
        xmPage: function D(K) {
            h(K, "onLoad", w), h(K, "onShow", u), h(K, "xmadClose", f), h(K, "appoIntView", g), l ? l(K) : Page(K)
        }
    }
};
exports.xmad = xmad;